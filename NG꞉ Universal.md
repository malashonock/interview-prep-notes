---
tags: [Angular/SSR]
title: 'NG: Universal'
created: '2023-09-08T07:27:43.242Z'
modified: '2024-03-26T13:36:46.364Z'
---

# NG: Universal


## Server-side rendering (SSR)


### Why use SSR?

SSR benefits:
- **Improved performace**: the browser can download and display fully rendered HTML even before it downloads app JS
- **Improved Core Web Vitals**:
  - First Contentful Paint (FCP)
  - Largest Contentful Paint (LCP)
  - Cumulative Layout Shift (CLS)
- **Improved SEO**

#### User retention

SPA visually displays a blank page until the app is rendered.  
This can take seconds, and many impatient users can close the page and never visit it again.

#### Search Engine Optimization (SEO)

Google's search engine crawlers are now capable of indexing even the content generated by JS.  
But many other search engines &mdash; can't, so we need to include some metadata in the `index.html` initially served.

Social media crawlers also need static metadata to display nice preview for emdedded links to our website.


### Using SSR

[SSR configuration](https://angular.dev/guide/ssr#configure-server-side-rendering)

Enable SSR in NG project:
```
ng new app-name --ssr // in a new project
ng add @angular/ssr   // add to existing project
```

Amongst other things, the above will add the following files:
- `./server.ts`:
  - contains all wiring for setting up and Express.js web server
  - in the only `GET *` endpoint, calls `CommonEngine#render()` that generates the initial HTML to serve
- `./src/main.server.ts`:
  - contains `bootstrap` fn that bootstraps an SSR NG application using the _merged_ (server+client) config (used by `CommonEngine#render()`)
- `./src/app/app.config.server.ts`:
  - contains server config with `provideServerRendering()` registered in `providers`
  - exports the merged server+client config to be consumed by `bootstrap`


### Hydration

[Angular.dev](https://angular.dev/guide/hydration#preserve-whitespaces-configuration)

Hydration is the process that reuses the initial HTML downloaded from the server and "breathes life" into it by:
- adding event listeners
- restoring app state
- transferring app data that was already retrieved by the server

Hydration **benefits**:
- _avoid extra work_ to recreate the DOM
- _avoid layout shift_ due to the DOM being destroyed and re-rendered otherwise


#### Using hydration

Hydration is enabled by default in a SSR NG app. Under the hood, NG adds `provideClientHydration()` to the root providers.


#### Hydration constaints

Hydration _assumes that the DOM trees served initially and generated on the client are the same_, hence the **constraints**:
- **Avoid direct DOM manipulation** on the title page, e.g.:
  - `innerHTML` / `outerHTML`
  - `appendChild`, detaching, moving nodes around
- **Ensure valid HTML structure** (use HTML validator)

Hydration currently isn **NOT supported** with:
- noop Zone.js
- i18n


#### Skipping hydration

For the components that violate the above constraints, viable workaround is to apply the `ngSkipHydration` directive to the component host element.


## Static site generation (SSG)

[Angular.dev](https://angular.dev/guide/prerendering/)

With SSG, initial page is not rendered on the server, but rather **pre-rendered** and served as **static content**.

**Usage**, with SSR enabled, simply run `ng build`, and NG will generate pre-rendered pages.

**Configuration** for SSG is done in `angular.json`'s `architect.build.options.prerender` section:
- `discoverRoutes` (optional, `true` by default): enables/disables SSG
- `routesFile` (optional): the path to a plain text file that contains the list of all routes to prerender (each route on a separate line)

Without the `routesFile`, only _unparameterized_ routes are pre-rendered.  
The `routesFile` is used to list _parameterized_ URL; usually by a script running before `ng build`. 
